{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "TCP Endpoint Configuration",
  "description": "TCP通信エンドポイントの設定",
  "type": "object",
  "required": ["protocol", "name", "direction"],
  "properties": {
    "protocol": {
      "type": "string",
      "enum": ["tcp"],
      "description": "プロトコルタイプ（TCP固定）"
    },
    "name": {
      "type": "string",
      "description": "エンドポイント名",
      "minLength": 1,
      "maxLength": 256,
      "examples": ["sensor_stream", "control_client"]
    },
    "direction": {
      "type": "string",
      "enum": ["in", "out", "inout"],
      "description": "通信方向"
    },
    "role": {
      "type": "string",
      "enum": ["client", "server"],
      "description": "接続役割（client: 接続開始, server: accept待ち）"
    },

    "local": { "$ref": "#/$defs/endpoint" },
    "remote": {
      "$ref": "#/$defs/endpoint",
      "description": "接続先（clientの場合に指定）"
    },

    "options": {
      "type": "object",
      "description": "オプション設定",
      "properties": {
        "backlog": {
          "type": "integer",
          "description": "サーバ受け入れキュー長（listen）",
          "minimum": 1,
          "maximum": 1024,
          "default": 5
        },
        "connect_timeout_ms": {
          "type": "integer",
          "description": "接続タイムアウト（ミリ秒）",
          "minimum": 0,
          "default": 1000
        },
        "read_timeout_ms": {
          "type": "integer",
          "description": "受信タイムアウト（ミリ秒）",
          "minimum": 0,
          "default": 1000
        },
        "write_timeout_ms": {
          "type": "integer",
          "description": "送信タイムアウト（ミリ秒）",
          "minimum": 0,
          "default": 1000
        },
        "blocking": {
          "type": "boolean",
          "description": "ブロッキングモード",
          "default": true
        },
        "reuse_address": {
          "type": "boolean",
          "description": "SO_REUSEADDRオプション",
          "default": true
        },
        "keepalive": {
          "type": "boolean",
          "description": "TCP keepalive 有効化",
          "default": true
        },
        "no_delay": {
          "type": "boolean",
          "description": "Nagleアルゴリズム無効化（TCP_NODELAY）",
          "default": true
        },
        "recv_buffer_size": {
          "type": "integer",
          "description": "受信バッファサイズ（バイト）",
          "minimum": 512,
          "maximum": 1048576,
          "default": 8192
        },
        "send_buffer_size": {
          "type": "integer",
          "description": "送信バッファサイズ（バイト）",
          "minimum": 512,
          "maximum": 1048576,
          "default": 8192
        },
        "linger": {
          "type": "object",
          "description": "SO_LINGERオプション",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "linger 有効化",
              "default": false
            },
            "timeout_sec": {
              "type": "integer",
              "description": "linger タイムアウト（秒）",
              "minimum": 0,
              "default": 0
            }
          },
          "required": ["enabled"],
          "if": { "properties": { "enabled": { "const": true } } },
          "then": { "required": ["timeout_sec"] }
        }
      }
    }
  },

  "allOf": [
    {
      "if": { "properties": { "direction": { "const": "in" } } },
      "then": {
        "required": ["local"],
        "properties": { "role": { "const": "server" } }
      }
    },
    {
      "if": { "properties": { "direction": { "const": "out" } } },
      "then": {
        "required": ["remote"],
        "properties": { "role": { "const": "client" } }
      }
    },
    {
      "if": { "properties": { "direction": { "const": "inout" } } },
      "then": { "required": ["role"] }
    },
    {
      "if": { "properties": { "role": { "const": "server" } } },
      "then": { "required": ["local"], "not": { "required": ["remote"] } }
    },
    {
      "if": { "properties": { "role": { "const": "client" } } },
      "then": { "required": ["remote"], "not": { "required": ["local"] } }
    }
  ],

  "$defs": {
    "endpoint": {
      "type": "object",
      "required": ["address", "port"],
      "properties": {
        "address": {
          "type": "string",
          "description": "IPアドレス（IPv4またはIPv6）",
          "oneOf": [
            { "format": "ipv4", "examples": ["192.168.1.100", "127.0.0.1"] },
            { "format": "ipv6", "examples": ["::1", "fe80::1"] }
          ]
        },
        "port": {
          "type": "integer",
          "description": "ポート番号",
          "minimum": 1,
          "maximum": 65535,
          "examples": [8080, 9000]
        }
      }
    }
  }
}
