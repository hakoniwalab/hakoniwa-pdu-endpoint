{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Communication Endpoint Configuration",
  "description": "Schema for communication endpoints (TCP, UDP, SHM, WebSocket).",
  "type": "object",
  "required": ["protocol"],
  "properties": {
    "protocol": {
      "type": "string",
      "enum": ["tcp", "udp", "shm", "websocket"],
      "description": "Protocol type."
    },
    "name": {
      "type": "string",
      "description": "Endpoint name.",
      "minLength": 1,
      "maxLength": 256
    },
    "direction": {
      "type": "string",
      "enum": ["in", "out", "inout"],
      "description": "Communication direction."
    },
    "comm_raw_version": {
      "type": "string",
      "enum": ["v1", "v2"],
      "description": "Optional raw packet format version for TCP/UDP/WebSocket."
    },
    "impl_type": {
      "type": "string",
      "enum": ["callback", "poll"],
      "description": "SHM implementation type."
    },
    "asset_name": {
      "type": "string",
      "description": "Target asset name for SHM poll implementation.",
      "minLength": 1
    },
    "role": {
      "type": "string",
      "enum": ["client", "server"],
      "description": "Client or server role (TCP/WebSocket)."
    },
    "local": {
      "type": "object",
      "description": "Local endpoint settings."
    },
    "remote": {
      "type": "object",
      "description": "Remote endpoint settings."
    },
    "expected_clients": {
      "type": "integer",
      "minimum": 1,
      "description": "Expected client count for TCP mux."
    },
    "io": {
      "$ref": "#/$defs/shm_io"
    },
    "options": {
      "type": "object",
      "description": "Socket and protocol options.",
      "properties": {
        "backlog": { "type": "integer", "description": "TCP server listen backlog." },
        "connect_timeout_ms": { "type": "integer", "description": "TCP/WebSocket connect timeout (ms)." },
        "read_timeout_ms": { "type": "integer", "description": "TCP/WebSocket read timeout (ms)." },
        "write_timeout_ms": { "type": "integer", "description": "TCP/WebSocket write timeout (ms)." },
        "blocking": { "type": "boolean", "description": "Blocking mode." },
        "reuse_address": { "type": "boolean", "description": "SO_REUSEADDR option." },
        "keepalive": { "type": "boolean", "description": "TCP keepalive." },
        "no_delay": { "type": "boolean", "description": "TCP_NODELAY (Nagle algorithm)." },
        "recv_buffer_size": { "type": "integer", "description": "Receive buffer size (bytes)." },
        "send_buffer_size": { "type": "integer", "description": "Send buffer size (bytes)." },
        "linger": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "timeout_sec": { "type": "integer" }
          },
          "required": ["enabled"]
        },
        "buffer_size": { "type": "integer", "description": "UDP buffer size (bytes)." },
        "timeout_ms": { "type": "integer", "description": "UDP timeout (ms)." },
        "broadcast": { "type": "boolean", "description": "UDP broadcast permission." },
        "multicast": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "group": { "type": "string", "format": "ipv4" },
            "interface": { "type": "string", "format": "ipv4" },
            "ttl": { "type": "integer" }
          },
          "required": ["enabled"],
          "if": { "properties": { "enabled": { "const": true } } },
          "then": { "required": ["group"] }
        }
      }
    }
  },
  "allOf": [
    {
      "if": { "properties": { "protocol": { "const": "tcp" } } },
      "then": {
        "required": ["direction"],
        "properties": {
          "local": { "$ref": "#/$defs/endpoint" },
          "remote": { "$ref": "#/$defs/endpoint" }
        },
        "anyOf": [
          {
            "required": ["expected_clients", "local"]
          },
          {
            "required": ["role"],
            "anyOf": [
              {
                "if": { "properties": { "direction": { "const": "in" } } },
                "then": { "required": ["local"], "properties": { "role": { "const": "server" } } }
              },
              {
                "if": { "properties": { "direction": { "const": "out" } } },
                "then": { "required": ["remote"], "properties": { "role": { "const": "client" } } }
              },
              {
                "if": { "properties": { "direction": { "const": "inout" } } },
                "then": {
                  "anyOf": [
                    { "if": { "properties": { "role": { "const": "server" } } }, "then": { "required": ["local"] } },
                    { "if": { "properties": { "role": { "const": "client" } } }, "then": { "required": ["remote"] } }
                  ]
                }
              }
            ]
          }
        ]
      }
    },
    {
      "if": { "properties": { "protocol": { "const": "udp" } } },
      "then": {
        "required": ["direction"],
        "properties": {
          "local": { "$ref": "#/$defs/endpoint" },
          "remote": { "$ref": "#/$defs/endpoint" }
        },
        "anyOf": [
          { "if": { "properties": { "direction": { "const": "in" } } }, "then": { "required": ["local"] } },
          { "if": { "properties": { "direction": { "const": "out" } } }, "then": { "required": ["remote"] } },
          { "if": { "properties": { "direction": { "const": "inout" } } }, "then": { "required": ["local"] } }
        ]
      }
    },
    {
      "if": { "properties": { "protocol": { "const": "websocket" } } },
      "then": {
        "required": ["role", "direction"],
        "properties": {
          "local": { "$ref": "#/$defs/ws_local" },
          "remote": { "$ref": "#/$defs/ws_remote" }
        },
        "anyOf": [
          {
            "if": { "properties": { "direction": { "const": "in" } } },
            "then": { "required": ["local"], "properties": { "role": { "const": "server" } } }
          },
          {
            "if": { "properties": { "direction": { "const": "out" } } },
            "then": { "required": ["remote"], "properties": { "role": { "const": "client" } } }
          },
          {
            "if": { "properties": { "direction": { "const": "inout" } } },
            "then": {
              "required": ["role"],
              "anyOf": [
                { "if": { "properties": { "role": { "const": "server" } } }, "then": { "required": ["local"] } },
                { "if": { "properties": { "role": { "const": "client" } } }, "then": { "required": ["remote"] } }
              ]
            }
          }
        ]
      }
    },
    {
      "if": { "properties": { "protocol": { "const": "shm" } } },
      "then": {
        "required": ["io", "impl_type"],
        "properties": {
          "io": { "$ref": "#/$defs/shm_io" }
        },
        "allOf": [
          {
            "if": { "properties": { "impl_type": { "const": "poll" } } },
            "then": { "required": ["asset_name"] }
          }
        ]
      }
    }
  ],
  "$defs": {
    "endpoint": {
      "type": "object",
      "required": ["address", "port"],
      "properties": {
        "address": {
          "type": "string",
          "description": "IP address (IPv4 or IPv6).",
          "oneOf": [
            { "format": "ipv4" },
            { "format": "ipv6" }
          ]
        },
        "port": {
          "type": "integer",
          "description": "Port number.",
          "minimum": 1,
          "maximum": 65535
        }
      }
    },
    "ws_local": {
      "type": "object",
      "required": ["port"],
      "properties": {
        "port": {
          "type": "integer",
          "description": "Listen port number.",
          "minimum": 1,
          "maximum": 65535
        }
      }
    },
    "ws_remote": {
      "type": "object",
      "required": ["host", "port"],
      "properties": {
        "host": {
          "type": "string",
          "description": "Remote host name or IP address.",
          "minLength": 1
        },
        "port": {
          "type": "integer",
          "description": "Remote port number.",
          "minimum": 1,
          "maximum": 65535
        },
        "path": {
          "type": "string",
          "description": "WebSocket path.",
          "minLength": 1,
          "default": "/"
        }
      }
    },
    "shm_io": {
      "type": "object",
      "required": ["robots"],
      "properties": {
        "robots": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/shm_robot" }
        }
      }
    },
    "shm_robot": {
      "type": "object",
      "required": ["name", "pdu"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "pdu": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/shm_pdu" }
        }
      }
    },
    "shm_pdu": {
      "type": "object",
      "required": ["name", "notify_on_recv"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "notify_on_recv": {
          "type": "boolean"
        }
      }
    }
  }
}
